## Framework-Independent Architecture (FIA)

### 概要

Framework-Independent Architecture （以降、FIA と略す）は、Swift でのアプリ開発において、Swift Package Manager を利用したマルチモジュール、マルチプロジェクト構成を採用し、Clean Architecture の設計概念をベースにしたアーキテクチャです。

<div align="center">
<img src="./asset/drawio/architecture_outline.drawio.svg"/>
</div>

FIA の目的は、Clean Architecture がもたらす独立性やテスタビリティといったメリットを活かしつつ、特に Xcode でのビルド時間を短縮することにあります。

FIA では、依存性の注入をプロジェクトでのアプリケーションのエントリーポイントで行い、プレゼンテーション層だけでなくアプリケーション層もクリーンな領域を保持します。これにより、フレームワーク層に依存しない状態でアプリケーションの高速ビルドが実現されます。

その結果、Xcode で行われる頻繁なビルド作業の時間が短縮され、全体の開発体験が向上します。

### FIA の採用背景

Swfit Package Manager の登場によって、[isowords](https://github.com/pointfreeco/isowords) を例にするように、自身のアプリケーションを容易にマルチモジュール、マルチプロジェクト構成を採用することができるようになりました。

一般的な Swfit Package Manager のモジュールの分割は、機能単位（Feature 単位）モジュールでの分割になりますが、FIA では、Clean Architecture でのレイヤー単位でモジュールを分割を採用しています。

また、モジュールの依存関係を `Package.Swift` に記述することで容易に管理できる Swfit Package Manager は、依存の方向が重要となる Clean Architecture と非常に相性がよく、 Swfit Package Manager と Clean Architecture の組み合わせの採用が容易になったと言えます。

さらに、FIA では依存性注入をプロジェクトでのアプリケーションのエントリーポイントで行い、DIコンテナとしてモックを設定することで、プロジェクトから参照する Frameworks and Librararies の項目からフレームワーク層のモジュールの依存しない開発・検証用のプロジェクトを用意することが可能にして、アプリケーションのビルドの際に Firebase に代表されるような依存するとビルドに大幅な時間がかかってしまう外部ライブラリからをビルド対象に含まなくなるため、高速なビルドができます。

これは Xcode Previews のビルドについても、フレームワーク層に依存されないためビルドの高速化が可能になります。


### FIA のメリットデメリット

#### メリット

- ビルド時間短縮：
- 独立性：フレームワークに依存しない設計により、ニーズの変化や新しい技術の出現に伴って異なるフレームワークや技術への移行が容易になります。
- テスタビリティ：関心の分離が明確でフレームワークからの分離があるため、コードの単位を独立してテストすることができ、包括的な単体テストとTDD（テスト駆動開発）を容易にします。
- メンテナビリティ：一つの層での変更が他の層に影響を与えないことが多く、コードベースの保守と進化を容易にします。
- 再利用性：
- スケーラビリティ：各層を独立してスケールアウトできるため、ターゲットとする最適化が可能になります。

#### デメリット

- 複雑性：複数の層と抽象化により、アーキテクチャが追加の複雑さをもたらすことがあり、これは単純なアプリケーションには過剰かもしれません。
- 学習曲線：開発者はアーキテクチャに慣れ、層間の相互作用を理解するために時間がかかるかもしれません。
- 開発時間：層間でのインターフェイスの定義と依存性注入メカニズムの設定が必要なため、アプリケーションの設定と開発に時間がかかることがあります。

### 実装

#### 実装コード

...あとで記述する

### テスタビリティ

FIA では Clean Architecture をベースとしているため、サードパーティー製のライブラリや、外部の API との疎通の処理をモックに差し替える依存性の注入の仕組みによって、各レイヤーの独立したテストコードが記述が可能です。

以下は、FIA によって可能なテストの種類と、そのテストによって担保されるテスト対象を示した表になります。

| テストの種類              |    Driver     | テスト対象: |      |           |            |        |
| ------------------------- | :-----------: | :---------: | :--: | :-------: | :--------: | :----: |
|                           |               |   Router    | View | Presenter | Interactor | Driver |
| App UI テスト (XCUITest)  | Actual / Mock |      ◎      |  ◯   |     ◯     |     ◯      | ◯ / -  |
| Xcode Previews            |     Mock      |      -      |  ◎   |     ◯     |     ◯      |   -    |
| Presenter ユニットテスト  | Actual / Mock |      -      |  -   |     ◎     |     ◯      | ◯ / -  |
| Interactor ユニットテスト | Actual / Mock |      -      |  -   |     -     |     ◎      | ◯ / -  |
| Driver ユニットテスト     |    Actual     |      -      |  -   |     -     |     -      |   ◎    |

※ ◎ : テスト対象、◯ : 付随的にテストされる対象

この表を念頭に置くことで、各テストで担保しなければならない範囲が明確になり、記述するテストコードの価値を高めることに繋がります。

<div align="center">
<img src="./asset/drawio/architecture_circle.drawio.svg"/>
</div>

<div align="center">
<img src="./asset/drawio/architecture_detail.drawio.svg"/>
</div>
